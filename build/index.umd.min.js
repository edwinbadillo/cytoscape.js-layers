!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CytoscapeLayers={})}(this,(function(e){"use strict";const t={position:"absolute",left:"0",top:"0",userSelect:"none",outlineStyle:"none",width:"100%",height:"100%"};function n(e){e.stopPropagation()}function s(e){e.addEventListener("click",n),e.addEventListener("mousedown",n),e.addEventListener("mouseup",n),e.addEventListener("mousemove",n)}class r{constructor(e){this.adapter=e,this.updateOnRenderEnabled=!1,this.updateOnRenderOnceEnabled=!1,this.updateOnRenderOnce=()=>{this.updateOnRenderOnceEnabled||(this.updateOnRenderOnceEnabled=!0,this.cy.one("render",(()=>{this.updateOnRenderOnceEnabled=!1,this.update()})))}}inVisibleBounds(e){return this.adapter.inVisibleBounds(e)}supportsRender(){return!1}renderInto(e){}get updateOnRender(){return this.updateOnRenderEnabled}set updateOnRender(e){this.updateOnRenderEnabled!==e&&(this.updateOnRenderEnabled=e,e?this.cy.on("render",this.update):this.cy.off("render",this.update))}get cy(){return this.adapter.cy}moveUp(){this.adapter.move(this,-1)}moveDown(){this.adapter.move(this,1)}moveBack(){this.adapter.move(this,Number.NEGATIVE_INFINITY)}moveFront(){this.adapter.move(this,Number.POSITIVE_INFINITY)}insertBefore(e,t){return this.adapter.insert("before",this,e,t)}insertAfter(e,t){return this.adapter.insert("after",this,e,t)}}class o extends r{constructor(e,n){super(e),this.callbacks=[],this.update=e=>{for(const t of this.callbacks)t(this.node,e)},this.root=n,Object.assign(this.root.style,t)}get visible(){return"none"!==this.root.style.display}set visible(e){this.visible!==e&&(this.root.style.display=e?"":"none")}show(){this.visible=!0}hide(){this.visible=!1}callback(e){return this.callbacks.push(e),this.update(),this}resize(){}remove(){this.root.remove()}}const i="http://www.w3.org/2000/svg";class a extends o{constructor(e,t,n={}){super(e,t.createElementNS(i,"svg")),this.type="svg",this.updateOnTransform=!1,this.root.__cy_layer=this,this.node=t.createElementNS(i,"g"),this.node.__cy_layer=this,this.root.appendChild(this.node),n.stopClicks&&s(this.node)}setViewport(e,t,n){this.node.setAttribute("transform",`translate(${e},${t})scale(${n})`),this.updateOnTransform&&this.update()}supportsRender(){return 0===this.node.childElementCount}}class d extends o{constructor(e,t,n={}){super(e,t.createElementNS(i,"svg")),this.type="svg-static",this.root.__cy_layer=this,this.node=t.createElementNS(i,"g"),this.node.__cy_layer=this,this.root.appendChild(this.node),n.stopClicks&&s(this.node)}setViewport(){}}class c extends r{constructor(e,n,r={}){var o,i;super(e),this.callbacks=[],this.transform={tx:0,ty:0,zoom:1},this.update=()=>this.draw(),this.node=n.createElement("canvas"),Object.assign(this.node.style,t),r.stopClicks&&s(this.node),this.pixelRatio=null!==(i=null!==(o=r.pixelRatio)&&void 0!==o?o:(null!==window&&void 0!==window?window:{}).devicePixelRatio)&&void 0!==i?i:1,this.ctx=this.node.getContext("2d",r),this.ctx.resetTransform()}get visible(){return"none"!==this.node.style.display}set visible(e){this.node.style.display=e?"":"none"}show(){this.visible=!0}hide(){this.visible=!1}get root(){return this.node}callback(e){return this.callbacks.push(e),this.update(),this}clear(){const e=this.ctx,t=e.getTransform();e.resetTransform(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.setTransform(t)}draw(){this.clear(),this.drawImpl(this.ctx)}drawImpl(e,t=1){e.save(),e.resetTransform(),e.scale(this.pixelRatio,this.pixelRatio),e.translate(this.transform.tx*t,this.transform.ty*t),e.scale(this.transform.zoom*t,this.transform.zoom*t);for(const t of this.callbacks)t(e,{});e.restore()}supportsRender(){return!0}renderInto(e){for(const t of this.callbacks)t(e,{forExport:!0})}resize(e,t){this.node.width=e*this.pixelRatio,this.node.height=t*this.pixelRatio,this.update()}setViewport(e,t,n){}remove(){this.node.remove()}}class l extends c{constructor(e,t,n={}){super(e,t,n),this.type="canvas",this.node.__cy_layer=this}setViewport(e,t,n){this.transform.tx=e,this.transform.ty=t,this.transform.zoom=n,this.update()}}class h extends c{constructor(e,t,n={}){super(e,t,n),this.type="canvas-static",this.node.__cy_layer=this}}class u extends o{constructor(e,t,n={}){super(e,t.createElement("div")),this.type="html",this.updateOnTransform=!1,this.root.__cy_layer=this,this.node=t.createElement("div"),this.node.__cy_layer=this,this.node.style.position="absolute",this.node.style.left="0px",this.node.style.top="0px",this.root.appendChild(this.node),n.stopClicks&&s(this.node)}setViewport(e,t,n){this.node.style.transform=`translate(${e}px,${t}px)scale(${n})`,this.updateOnTransform&&this.update()}supportsRender(){return 0===this.node.childElementCount}}class p extends o{constructor(e,t,n={}){super(e,t.createElement("div")),this.type="html-static",this.node.__cy_layer=this,n.stopClicks&&s(this.node)}get node(){return this.root}setViewport(){}}class y extends r{constructor(e,t){super(e),this.update=()=>{},this.node=t}get root(){return this.node}resize(){}setViewport(){}remove(){}supportsRender(){return!0}}class f extends y{constructor(e,t){super(e,t),this.type="node",this.node.__cy_layer=this}}class m extends y{constructor(e,t){super(e,t),this.type="drag",this.node.__cy_layer=this}}class v extends y{constructor(e,t){super(e,t),this.type="select-box",this.node.__cy_layer=this}}function g(e,t,n){const s=Array.from(e.children);if(!n.uniqueElements){t.forEach((t=>{if(t.removed())return;const r=n.bb(t);if(n.isVisible(r))if(s.length>0)n.update(s.shift(),t,r);else{const s=n.enter(t,r);e.appendChild(s),n.update(s,t,r)}}));for(const e of s)e.remove();return}const r=new Map(s.map((e=>[e.dataset.id,e])));let o=-1;t.forEach((t=>{if(t.removed()){if(n.allowPartialUpdate){const e=t.id(),n=r.get(e);r.delete(e),n&&n.remove()}return}const i=n.bb(t);if(!n.isVisible(i))return;o++;const a=t.id(),d=s[o],c=r.get(a);let l;if(c){if(n.update(c,t,i),r.delete(a),d===c)return;l=c}else l=n.enter(t,i),l.dataset.id=a,n.update(l,t,i);0===o?e.insertAdjacentElement("afterbegin",l):s[o-1].insertAdjacentElement("afterend",l),s.splice(o,0,l)})),n.allowPartialUpdate||r.forEach((e=>e.remove()))}function b(e,t){return e.callback(t),{remove:()=>{e.callbacks.splice(e.callbacks.indexOf(t),1)}}}function w(e){return{selector:":visible",updateOn:null!=e&&e.queryEachTime?"render":"position",queryEachTime:!1,checkBounds:!0}}function O(e,t,n){const s=Object.assign({checkBoundsPointCount:5,initCollection:()=>{}},w(n),n);let r=e.cy.collection(),o=!1;const i=()=>{o||(o=!0,e.cy.one("render",(()=>{o=!1,r=a(r),e.update()})))},a=t=>{"none"!==s.updateOn&&"render"!==s.updateOn&&(t.off(s.updateOn,void 0,e.updateOnRenderOnce),t.sources().off(s.updateOn,void 0,e.updateOnRenderOnce),t.targets().off(s.updateOn,void 0,e.updateOnRenderOnce));const n=e.cy.edges(s.selector);return s.initCollection(n),"none"!==s.updateOn&&"render"!==s.updateOn&&(n.on(s.updateOn,e.updateOnRenderOnce),n.sources().on(s.updateOn,e.updateOnRenderOnce),n.targets().on(s.updateOn,e.updateOnRenderOnce)),e.updateOnRenderOnce(),n};"render"===s.updateOn&&(e.updateOnRender=!0),s.queryEachTime||(r=a(r),e.cy.on("add remove",s.selector,i));const d=b(e,((n,o)=>{s.queryEachTime&&(r=a(r)),r.forEach((r=>{if(r.removed())return;const i=r._private.rscratch,a=i&&null!=i.startX&&null!=i.startY?{x:i.startX,y:i.startY}:r.sourceEndpoint(),d=i&&null!=i.endX&&null!=i.endY?{x:i.endX,y:i.endY}:r.targetEndpoint();if(!(null==o?void 0:o.forExport)&&s.checkBounds&&s.checkBoundsPointCount>0&&!function(e,t,n,s){const r=e=>({x:t.x*e+n.x*(1-e),y:t.y*e+n.y*(1-e)});if(1===s)return e.inVisibleBounds(r(.5));const o=1/s;for(let t=0;t<=s;t++)if(e.inVisibleBounds(r(t*o)))return!0;return!1}(e,a,d,s.checkBoundsPointCount))return;if(i&&i.pathCache)return void t(n,r,i.pathCache,a,d);const c=new Path2D;c.moveTo(a.x,a.y),c.lineTo(d.x,d.y),t(n,r,c,a,d)}))}));return{layer:e,edges:r,remove:()=>{"none"!==s.updateOn&&"render"!==s.updateOn&&(r.off(s.updateOn,void 0,e.updateOnRenderOnce),r.sources().off(s.updateOn,void 0,e.updateOnRenderOnce),r.targets().off(s.updateOn,void 0,e.updateOnRenderOnce)),e.cy.off("add remove",s.selector,i),d.remove()}}}function x(e,t,n={}){const s=Object.assign({transform:"",position:"top-left",boundingBox:{includeLabels:!1,includeOverlays:!1},uniqueElements:!1,allowPartialUpdate:!1,initCollection:()=>{}},w(n),n);let r=e.cy.collection(),o=!1;const a=()=>{o||(o=!0,e.cy.one("render",(()=>{o=!1,r=c(r),e.update()})))},d=t=>{const n=t.target;r=r.difference(n),e.update(n)},c=t=>{"none"!==s.updateOn&&"render"!==s.updateOn&&(t.off(s.updateOn,void 0,e.updateOnRenderOnce),s.allowPartialUpdate&&t.off("remove",s.selector,d));const n=e.cy.nodes(s.selector);return s.initCollection(n),"none"!==s.updateOn&&"render"!==s.updateOn&&(n.on(s.updateOn,e.updateOnRenderOnce),s.allowPartialUpdate&&n.on("remove",s.selector,d)),e.updateOnRenderOnce(),n};"render"===s.updateOn&&(e.updateOnRender=!0),s.queryEachTime||(r=c(r),s.allowPartialUpdate&&"none"!==s.updateOn&&"render"!==s.updateOn?(e.cy.on("add",s.selector,a),e.cy.on("remove",s.selector,d)):e.cy.on("add remove",s.selector,a));const l=t=>({layer:e,nodes:r,remove:()=>{"none"!==s.updateOn&&"render"!==s.updateOn&&(r.off(s.updateOn,void 0,e.updateOnRenderOnce),s.allowPartialUpdate&&r.off("remove",s.selector,d)),e.cy.off("add remove",s.selector,a),t.remove()}});if("canvas"===e.type){const n=s,o=(o,i)=>{const a=o.getTransform();s.queryEachTime&&(r=c(r)),r.forEach((r=>{if(r.removed())return;const d=r.boundingBox(s.boundingBox);if(i.forExport||!n.checkBounds||e.inVisibleBounds(d)){if("top-left"===n.position)o.translate(d.x1,d.y1);else if("center"===n.position){const e=r.position();o.translate(e.x,e.y)}t(o,r,d),"none"!==n.position&&o.setTransform(a)}}))};return l(b(e,o))}const h=s,u={bb:e=>e.boundingBox(h.boundingBox),isVisible:h.checkBounds?t=>e.inVisibleBounds(t):()=>!0,uniqueElements:!0===h.uniqueElements||!0===h.allowPartialUpdate,allowPartialUpdate:!0===h.allowPartialUpdate};if(h.checkBounds&&(e.updateOnTransform=!0),"html"===e.type){const n={...u,enter:(t,n)=>{const s=e.node.ownerDocument.createElement("div");return s.style.position="absolute",h.init&&h.init(s,t,n),s},update:(e,n,s)=>{if("top-left"===h.position)e.style.transform=`${h.transform}translate3d(${s.x1}px,${s.y1}px,0)`;else if("center"===h.position){const t=n.position();e.style.transform=`${h.transform}translate3d(${t.x}px,${t.y}px,0)`}t(e,n,s)}};return l(b(e,((e,t)=>{var o;s.queryEachTime?(r=c(r),g(e,r,n)):(null===(o=null==t?void 0:t.isNode)||void 0===o?void 0:o.call(t))?g(e,t,n):g(e,r,n)})))}const p={...u,enter:(t,n)=>{const s=e.node.ownerDocument.createElementNS(i,"g");return h.init&&h.init(s,t,n),s},update:(e,n,s)=>{if("top-left"===h.position)e.setAttribute("transform",`${h.transform}translate3d(${s.x1},${s.y1},0)`);else if("center"===h.position){const t=n.position();e.setAttribute("transform",`${h.transform}translate3d(${t.x},${t.y},0)`)}t(e,n,s)}};return l(b(e,((e,t)=>{var n;s.queryEachTime?(r=c(r),g(e,r,p)):(null===(n=null==t?void 0:t.isNode)||void 0===n?void 0:n.call(t))?g(e,t,p):g(e,r,p)})))}function E(e){const t=e.indexOf(",");return e.substring(t+1)}function _(e,t,n){const s=function(){return t.toDataURL(n,e.quality)};switch(e.output){case"blob-promise":return new Promise(((s,r)=>{try{t.toBlob((function(e){null!=e?s(e):r(new Error("`canvas.toBlob()` sent a null value in its callback"))}),n,e.quality)}catch(e){r(e)}}));case"blob":return function(e,t){const n=atob(e),s=new ArrayBuffer(n.length),r=new Uint8Array(s);for(let e=0;e<n.length;e++)r[e]=n.charCodeAt(e);return new Blob([s],{type:t})}(E(s()),n);case"base64":return E(s());default:return s()}}class R extends Error{}class k{constructor(e){this.bak={},this.resize=()=>{const e=this.cy.width(),t=this.cy.height();this.viewport.width=e,this.viewport.height=t;for(const n of this.layers)n.resize(e,t)},this.destroy=()=>{for(const e of this.layers)e.remove();this.cy.off("destroy",this.destroy),this.cy.off("viewport",this.zoomed),this.cy.off("resize",this.resize),this.cy.scratch("_layers",void 0),this.cy.png=this.bak.png,this.cy.jpg=this.bak.jpg,this.cy.jpeg=this.bak.jpeg,this.bak={}},this.zoomed=()=>{const e=this.cy.pan(),t=this.cy.zoom();this.viewport.tx=e.x,this.viewport.ty=e.y,this.viewport.zoom=t;for(const n of this.layers)n.setViewport(e.x,e.y,t)},this.renderPerEdge=O,this.renderPerNode=x,this.cy=e,this.adapter={cy:this.cy,insert:(e,t,n)=>this.insert(e,t,n),move:(e,t)=>this.move(e,t),inVisibleBounds:e=>{const t=this.viewport,n=e=>{const n=e*t.zoom+t.tx;return n>=0&&n<=t.width},s=e=>{const n=e*t.zoom+t.ty;return n>=0&&n<=t.height};return function(e){return null!=e.x}(e)?n(e.x)&&s(e.y):n(e.x1)&&s(e.y1)||n(e.x2)&&s(e.y1)||n(e.x2)&&s(e.y2)||n(e.x1)&&s(e.y2)||n((e.x1+e.x2)/2)&&s((e.y1+e.y2)/2)}};const t=e.container(),n=new f(this.adapter,t.querySelector('[data-id="layer2-node"]'));this.nodeLayer=n;const s=new m(this.adapter,t.querySelector('[data-id="layer1-drag"]'));this.dragLayer=s;const r=new v(this.adapter,t.querySelector('[data-id="layer0-selectbox"]'));this.selectBoxLayer=r,n.root.style.zIndex="",s.root.style.zIndex="",r.root.style.zIndex="",n.root.insertAdjacentElement("afterend",s.root),s.root.insertAdjacentElement("afterend",r.root),e.on("viewport",this.zoomed),e.on("resize",this.resize),e.on("destroy",this.destroy),this.bak={png:e.png,jpg:e.jpg,jpeg:e.jpeg},e.png=this.png.bind(this),e.jpg=this.jpg.bind(this),e.jpeg=this.jpeg.bind(this),this.viewport={width:this.cy.width(),height:this.cy.height(),tx:this.cy.pan().x,ty:this.cy.pan().y,zoom:this.cy.zoom()}}move(e,t){const n=this.layers,s=n.indexOf(e),r=Math.max(Math.min(s+t,n.length,0));r!==s&&(s>=n.length-1?this.root.appendChild(e.root):this.root.insertBefore(e.root,n[r].root))}get document(){return this.cy.container().ownerDocument}get root(){return this.nodeLayer.node.parentElement}get layers(){return Array.from(this.root.children).map((e=>e.__cy_layer)).filter((e=>null!=e))}getLayers(){return this.layers}init(e){return e.resize(this.viewport.width,this.viewport.height),e.setViewport(this.viewport.tx,this.viewport.ty,this.viewport.zoom),e}update(){this.zoomed();for(const e of this.layers)e instanceof l&&e.draw()}createLayer(e,t){switch(e){case"svg":return this.init(new a(this.adapter,this.document,t));case"html":return this.init(new u(this.adapter,this.document,t));case"canvas":return this.init(new l(this.adapter,this.document,t));case"html-static":return this.init(new p(this.adapter,this.document,t));case"svg-static":return this.init(new d(this.adapter,this.document,t));case"canvas-static":return this.init(new h(this.adapter,this.document,t))}}append(e,t){const n=this.createLayer(e,t);return this.root.appendChild(n.root),n}insert(e,t,n,s){const r=this.createLayer(n,s);return t.root.insertAdjacentElement("before"===e?"beforebegin":"afterend",r.root),r}getLast(){var e;const t=this.layers;return null!==(e=t[t.length-1])&&void 0!==e?e:null}getFirst(){var e;return null!==(e=this.layers[0])&&void 0!==e?e:null}hasCustomLayer(){return this.layers.some((e=>!(e instanceof y)))}toCanvas(e){const t=this.layers;if(t.some((e=>!e.supportsRender))&&!e.ignoreUnsupportedLayers)throw new R("some layer doesn't support exporting, use {ignoreUnsupportedLayers: true} option to ignore");const n=t.indexOf(this.nodeLayer),s=t.indexOf(this.dragLayer),r=t.indexOf(this.selectBoxLayer);if((n!==s-1||s!==r-1)&&!e.ignoreUnsupportedLayerOrder)throw new R("cytoscape layers are not in order, use {ignoreUnsupportedLayerOrder: true} option to ignore");const o=t.slice(0,n).reverse().filter((e=>e.supportsRender()&&e!==this.dragLayer&&e!==this.selectBoxLayer)),i=t.slice(n+1).filter((e=>e.supportsRender()&&e!==this.dragLayer&&e!==this.selectBoxLayer)),a=this.cy.renderer(),d=a.drawElements;a.drawElements=function(e,t){for(const t of o)t.renderInto(e);d.call(this,e,t);for(const t of i)t.renderInto(e)};const c=a.bufferCanvasImage(e);return a.drawElements=d,c}png(e){return this.hasCustomLayer()?_(null!=e?e:{},this.toCanvas(null!=e?e:{}),"image/png"):this.bak.png.call(this.cy,e)}jpg(e){if(!this.hasCustomLayer())return this.bak.jpg.call(this.cy,e);const t={bg:"#fff",...null!=e?e:{}};return _(t,this.toCanvas(t),"image/png")}jpeg(e){return this.hasCustomLayer()?this.jpg(e):this.bak.jpeg.call(this.cy,e)}}function C(e=this){if(!e.container())throw new Error("layers plugin does not work in headless environments");const t=e.scratch("_layers");if(t)return t;const n=new k(e);return e.scratch("_layers",n),n}function L(e){e("core","layers",C)}void 0!==window.cytoscape&&L(window.cytoscape),e.LayerExportException=R,e.LayersPlugin=k,e.default=L,e.layers=C,e.renderPerEdge=O,e.renderPerNode=x,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.min.js.map
